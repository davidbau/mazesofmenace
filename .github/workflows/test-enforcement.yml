name: Test Enforcement

# The Wizard of Yendor watches all commits...

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  enforce-test-log:
    runs-on: ubuntu-latest
    name: Verify Test Log Entry

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git notes

      # Fetch git notes (for git notes approach)
      - name: Fetch test notes
        run: |
          git fetch origin refs/notes/test-results:refs/notes/test-results || echo "No test notes yet"

      - name: Check test log update
        id: check-log
        run: |
          echo "Checking if teststats/results.jsonl was updated..."

          if git diff --name-only HEAD^ HEAD | grep -q "teststats/results.jsonl"; then
            echo "log_updated=true" >> $GITHUB_OUTPUT
            echo "✅ Test log was updated"
          else
            echo "log_updated=false" >> $GITHUB_OUTPUT
            echo "⚠️  Test log was NOT updated"
          fi

      - name: Check for test note (git notes approach)
        id: check-note
        run: |
          if git notes --ref=test-results show HEAD >/dev/null 2>&1; then
            echo "note_exists=true" >> $GITHUB_OUTPUT
            echo "✅ Test note exists for HEAD"
            echo ""
            echo "Note contents:"
            git notes --ref=test-results show HEAD | jq '.'
          else
            echo "note_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  No test note found for HEAD"
          fi

      - name: Verify exactly one new entry (JSONL)
        if: steps.check-log.outputs.log_updated == 'true'
        run: |
          # Count lines in new vs old version
          OLD_LINES=$(git show HEAD^:teststats/results.jsonl 2>/dev/null | wc -l || echo 0)
          NEW_LINES=$(wc -l < teststats/results.jsonl)
          DIFF=$((NEW_LINES - OLD_LINES))

          echo "Old lines: $OLD_LINES"
          echo "New lines: $NEW_LINES"
          echo "Difference: $DIFF"

          if [ $DIFF -eq 1 ]; then
            echo "✅ Exactly one new test log entry added"
          elif [ $DIFF -eq 0 ]; then
            echo "⚠️  Test log was modified but no new entry added"
            echo "   (Acceptable if updating existing entries)"
          elif [ $DIFF -gt 1 ]; then
            echo "⚠️  Multiple entries added ($DIFF entries)"
            echo "   This may be intentional (e.g., backfilling or sync from notes)"
          else
            echo "❌ Test log entries were removed ($DIFF entries)"
            exit 1
          fi

      - name: Validate JSONL format
        if: steps.check-log.outputs.log_updated == 'true'
        run: |
          echo "Validating JSONL format..."
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              if ! echo "$line" | jq empty 2>/dev/null; then
                echo "❌ Invalid JSON in test log:"
                echo "$line"
                exit 1
              fi
            fi
          done < teststats/results.jsonl
          echo "✅ All entries are valid JSON"

      - name: Check for regression
        if: steps.check-log.outputs.log_updated == 'true'
        run: |
          # Get last two entries
          ENTRY_COUNT=$(wc -l < teststats/results.jsonl)

          if [ "$ENTRY_COUNT" -lt 2 ]; then
            echo "ℹ️  Only one entry in log, skipping regression check"
            exit 0
          fi

          LAST_ENTRY=$(tail -1 teststats/results.jsonl)
          PREV_ENTRY=$(tail -2 teststats/results.jsonl | head -1)

          LAST_PASS=$(echo "$LAST_ENTRY" | jq -r '.stats.pass')
          PREV_PASS=$(echo "$PREV_ENTRY" | jq -r '.stats.pass // 0')

          echo "Previous pass count: $PREV_PASS"
          echo "Current pass count: $LAST_PASS"

          if [ "$LAST_PASS" -lt "$PREV_PASS" ]; then
            REGRESSION_FLAG=$(echo "$LAST_ENTRY" | jq -r '.regression')
            echo "⚠️  WARNING: Tests regressed (pass count decreased by $((PREV_PASS - LAST_PASS)))"

            if [ "$REGRESSION_FLAG" != "true" ]; then
              echo "❌ Regression occurred but not marked in test log"
              echo "   Please review and either fix the regression or mark it as intentional"
              echo ""
              echo "To allow regression:"
              echo "  .githooks/test-and-log-to-note.sh --allow-regression"
              echo "  # or"
              echo "  .githooks/test-and-log.sh --allow-regression"
              exit 1
            else
              echo "✅ Regression is marked as intentional in test log"
            fi
          else
            echo "✅ No regression detected"
          fi

      - name: Enforcement result
        if: always()
        run: |
          LOG_UPDATED="${{ steps.check-log.outputs.log_updated }}"
          NOTE_EXISTS="${{ steps.check-note.outputs.note_exists }}"

          echo ""
          echo "=========================================="
          echo "Test Enforcement Summary"
          echo "=========================================="
          echo "JSONL updated: $LOG_UPDATED"
          echo "Git note exists: $NOTE_EXISTS"
          echo ""

          # Accept either approach
          if [ "$LOG_UPDATED" = "true" ] || [ "$NOTE_EXISTS" = "true" ]; then
            echo "✅ PASSED: Tests are logged"
            echo ""
            if [ "$NOTE_EXISTS" = "true" ]; then
              echo "Using git notes approach (recommended)"
              if [ "$LOG_UPDATED" = "false" ]; then
                echo ""
                echo "⚠️  Note: JSONL not updated yet"
                echo "   The pre-commit hook will sync notes → JSONL on next commit"
                echo "   Dashboard will be one commit behind (this is expected)"
              fi
            else
              echo "Using two-commit approach (legacy)"
            fi
            exit 0
          else
            echo "❌ FAILED: No test log found"
            echo ""
            echo "Every commit must include test results."
            echo ""
            echo "Choose an approach:"
            echo ""
            echo "1. Git Notes (recommended):"
            echo "   .githooks/commit-with-tests-notes.sh 'message' file.js"
            echo ""
            echo "2. Two-Commit (legacy):"
            echo "   .githooks/commit-with-tests.sh 'message' file.js"
            echo ""
            echo "Or set up the git hook:"
            echo "   git config core.hooksPath .githooks"
            echo ""
            echo "Documentation:"
            echo "   TESTING_DASHBOARD.md"
            echo "   docs/TESTING_GIT_NOTES.md"
            exit 1
          fi
