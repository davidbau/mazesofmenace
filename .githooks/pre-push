#!/bin/bash
# Pre-push hook: Run tests and log results before allowing push
# Install: git config core.hooksPath .githooks

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if setup has been run
source "$SCRIPT_DIR/check-setup.sh"
if ! check_setup; then
  echo "Push blocked until setup is complete."
  exit 1
fi

echo "========================================"
echo "Pre-push hook: Running tests..."
echo "========================================"

# Run test-and-log script
"$SCRIPT_DIR/test-and-log.sh"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo ""
  echo "✅ Tests passed and logged. Push allowed."

  # Check if test log was updated
  if git diff --quiet teststats/results.jsonl 2>/dev/null; then
    # No changes to test log - this is expected for initial commit
    if [ ! -f teststats/results.jsonl ]; then
      echo ""
      echo "⚠️  No test log exists yet. Creating initial entry..."
      # This will create the log file
    else
      echo ""
      echo "✅ Test log already committed"
    fi
  else
    echo ""
    echo "⚠️  teststats/results.jsonl has uncommitted changes"
    echo ""
    echo "   Workflow: Tests log results for CURRENT commit"
    echo "   The test log entry should be committed SEPARATELY:"
    echo ""
    echo "   git add teststats/results.jsonl"
    echo "   git commit -m 'Add test results for commit $(git rev-parse --short HEAD)'"
    echo ""
    echo "   Then push again."
    exit 1
  fi
else
  echo ""
  echo "❌ Tests failed or regressed. Push rejected."
  echo "   Fix the issues or use --allow-regression flag"
  exit 1
fi

exit 0
